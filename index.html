<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meta Ads Creator</title>
    <!-- Elite Brands typography: Space Grotesk (headings) + Inter (body) -->
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@500;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        /* â”€â”€ Elite Brands Design Tokens â”€â”€ */
        :root {
            --cyan:        #2AAEE0;
            --cyan-hover:  #2393BE;
            --cyan-active: #1D799C;
            --ink:         #050816;
            --surface:     #0B1B26;
            --slate:       #507284;
            --border:      rgba(148,163,184,0.15);
            --border-form: #4B5563;
            --placeholder: #9CA3AF;
            --text:        #E8F4FA;
            --text-muted:  #507284;
            --error:       #FF6B6B;
            --success:     #10b981;
            --radius-card: 18px;
            --radius-pill: 999px;
            --radius-sm:   10px;
        }

        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--ink);
            color: var(--text);
            min-height: 100vh;
            line-height: 1.6;
        }

        h1, h2, h3, h4 {
            font-family: 'Space Grotesk', 'Inter', sans-serif;
        }

        .app {
            max-width: 1100px;
            margin: 0 auto;
            padding: 32px 24px;
        }

        /* State visibility */
        .state { display: none; }
        .state.active { display: block; }

        /* â”€â”€ Header â”€â”€ */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 32px;
        }
        .header-title {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .header-title h1 {
            font-size: 20px;
            font-weight: 600;
            letter-spacing: -0.02em;
            color: var(--text);
        }
        .header-title .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--cyan);
            flex-shrink: 0;
            box-shadow: 0 0 8px rgba(42,174,224,0.5);
        }

        /* â”€â”€ Cards â”€â”€ */
        .card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-card);
            padding: 28px;
            box-shadow: 0 4px 24px rgba(5,8,22,0.4);
        }

        /* â”€â”€ Form elements â”€â”€ */
        label {
            display: block;
            font-size: 11px;
            font-weight: 600;
            color: var(--slate);
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.7px;
        }

        input[type="text"], input[type="url"], input[type="password"] {
            width: 100%;
            background: rgba(5,8,22,0.6);
            border: 1px solid var(--border-form);
            border-radius: var(--radius-sm);
            padding: 10px 14px;
            color: var(--text);
            font-size: 14px;
            font-family: inherit;
            transition: border-color 0.2s, box-shadow 0.2s;
            outline: none;
        }
        input:focus {
            border-color: var(--cyan);
            box-shadow: 0 0 0 2px rgba(42,174,224,0.15);
        }
        input::placeholder { color: var(--placeholder); }

        .field { margin-bottom: 20px; }

        /* â”€â”€ Buttons â”€â”€ */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 22px;
            border-radius: var(--radius-pill);
            font-size: 14px;
            font-weight: 600;
            font-family: 'Space Grotesk', inherit;
            cursor: pointer;
            border: none;
            transition: all 0.15s;
            text-decoration: none;
            letter-spacing: -0.01em;
        }
        .btn-primary {
            background: var(--cyan);
            color: var(--ink);
        }
        .btn-primary:hover:not(:disabled) {
            background: var(--cyan-hover);
            transform: translateY(-1px);
            box-shadow: 0 4px 18px rgba(42,174,224,0.35);
        }
        .btn-primary:active:not(:disabled) { background: var(--cyan-active); }
        .btn-secondary {
            background: transparent;
            color: var(--cyan);
            border: 1px solid var(--cyan);
        }
        .btn-secondary:hover:not(:disabled) {
            background: rgba(42,174,224,0.08);
        }
        .btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none !important; box-shadow: none !important; }
        .btn-sm { padding: 7px 16px; font-size: 13px; }

        /* â”€â”€ Setup state â”€â”€ */
        #setup-state {
            display: none;
            justify-content: center;
            align-items: center;
            min-height: 80vh;
        }
        #setup-state.active { display: flex; }

        .setup-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-card);
            padding: 44px 40px;
            width: 100%;
            max-width: 460px;
            text-align: center;
            box-shadow: 0 8px 40px rgba(5,8,22,0.6);
        }
        .setup-logo {
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, var(--cyan), var(--cyan-active));
            border-radius: 16px;
            margin: 0 auto 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 4px 20px rgba(42,174,224,0.3);
        }
        .setup-card h2 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
            letter-spacing: -0.02em;
            color: var(--text);
        }
        .setup-card > p { color: var(--slate); font-size: 14px; margin-bottom: 28px; line-height: 1.6; }
        .setup-card .field { text-align: left; }
        .setup-help { margin-top: 16px; font-size: 12px; color: var(--slate); }
        .setup-help a { color: var(--cyan); text-decoration: none; }
        .setup-help a:hover { text-decoration: underline; }

        /* â”€â”€ Form state â”€â”€ */
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }
        @media (max-width: 640px) { .form-grid { grid-template-columns: 1fr; } }

        .section-divider {
            border: none;
            border-top: 1px solid var(--border);
            margin: 24px 0;
        }

        .templates-label-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }
        .templates-label-row label { margin-bottom: 0; }
        .templates-hint { font-size: 12px; color: var(--slate); }

        .templates-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
            gap: 10px;
        }

        .template-card {
            position: relative;
            cursor: pointer;
            border-radius: var(--radius-sm);
            overflow: hidden;
            border: 2px solid rgba(148,163,184,0.12);
            aspect-ratio: 9/16;
            background: var(--ink);
            transition: border-color 0.15s, transform 0.15s, box-shadow 0.15s;
        }
        .template-card:hover {
            border-color: rgba(42,174,224,0.5);
            transform: scale(1.02);
            box-shadow: 0 4px 16px rgba(42,174,224,0.15);
        }
        .template-card.selected {
            border-color: var(--cyan);
            box-shadow: 0 0 0 1px var(--cyan), 0 4px 16px rgba(42,174,224,0.2);
        }
        .template-card .check-badge {
            display: none;
            position: absolute;
            top: 6px;
            right: 6px;
            width: 20px;
            height: 20px;
            background: var(--cyan);
            border-radius: 50%;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 700;
            color: var(--ink);
        }
        .template-card.selected .check-badge { display: flex; }
        .template-card img { width: 100%; height: 100%; object-fit: cover; display: block; }
        .template-name {
            position: absolute;
            bottom: 0; left: 0; right: 0;
            padding: 4px 6px;
            background: rgba(5,8,22,0.75);
            font-size: 10px;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: var(--placeholder);
        }

        .no-templates {
            padding: 28px 20px;
            text-align: center;
            color: var(--slate);
            font-size: 13px;
            background: rgba(42,174,224,0.03);
            border: 1px dashed rgba(42,174,224,0.2);
            border-radius: var(--radius-sm);
            line-height: 1.7;
        }
        .no-templates code {
            background: rgba(42,174,224,0.08);
            color: var(--cyan);
            padding: 1px 5px;
            border-radius: 3px;
            font-size: 11px;
        }

        .form-footer {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 24px;
            flex-wrap: wrap;
            gap: 12px;
        }
        .selection-info { font-size: 13px; color: var(--slate); }

        /* Settings gear button */
        .icon-btn {
            background: none;
            border: 1px solid var(--border-form);
            border-radius: var(--radius-sm);
            padding: 8px 10px;
            cursor: pointer;
            color: var(--slate);
            font-size: 15px;
            line-height: 1;
            transition: all 0.15s;
        }
        .icon-btn:hover { color: var(--cyan); border-color: var(--cyan); }

        /* Error banner */
        .error-banner {
            display: none;
            background: rgba(255,107,107,0.08);
            border: 1px solid rgba(255,107,107,0.25);
            border-radius: var(--radius-sm);
            padding: 11px 16px;
            font-size: 13px;
            color: var(--error);
            margin-bottom: 20px;
        }
        .error-banner.visible { display: block; }

        /* â”€â”€ Progress state â”€â”€ */
        .progress-wrap {
            max-width: 580px;
            margin: 60px auto;
        }
        .progress-header { margin-bottom: 36px; }
        .progress-header h2 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 6px;
            letter-spacing: -0.02em;
        }
        .progress-header p { color: var(--slate); font-size: 14px; }

        .progress-steps { list-style: none; }

        .step-item {
            display: flex;
            align-items: flex-start;
            gap: 16px;
            padding: 10px 0;
            position: relative;
        }
        .step-item:not(:last-child)::after {
            content: '';
            position: absolute;
            left: 15px;
            top: 46px;
            width: 2px;
            height: calc(100% - 16px);
            background: rgba(148,163,184,0.1);
        }
        .step-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 15px;
            background: rgba(148,163,184,0.06);
            border: 2px solid rgba(148,163,184,0.15);
            transition: all 0.3s;
        }
        .step-item.active .step-icon {
            background: rgba(42,174,224,0.12);
            border-color: var(--cyan);
            animation: stepPulse 1.5s ease-in-out infinite;
        }
        .step-item.done .step-icon {
            background: rgba(16,185,129,0.1);
            border-color: var(--success);
            font-size: 14px;
        }
        .step-item.error .step-icon {
            background: rgba(255,107,107,0.1);
            border-color: var(--error);
            font-size: 14px;
        }
        @keyframes stepPulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(42,174,224,0); }
            50%       { box-shadow: 0 0 0 5px rgba(42,174,224,0.2); }
        }

        .step-body { flex: 1; padding-top: 4px; }
        .step-body h4 { font-size: 14px; font-weight: 500; line-height: 1.4; }
        .step-detail { font-size: 12px; color: var(--slate); margin-top: 2px; transition: color 0.3s; }
        .step-item.done .step-detail { color: rgba(16,185,129,0.8); }
        .step-item.error .step-detail { color: var(--error); }

        .progress-bar-wrap {
            margin-top: 36px;
            background: rgba(148,163,184,0.08);
            border-radius: 4px;
            height: 3px;
            overflow: hidden;
        }
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--cyan-active), var(--cyan));
            border-radius: 4px;
            transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            width: 0%;
        }

        /* â”€â”€ Results state â”€â”€ */
        .results-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 24px;
            flex-wrap: wrap;
            gap: 12px;
        }
        .results-header h2 {
            font-size: 22px;
            font-weight: 600;
            letter-spacing: -0.02em;
        }
        .results-meta { font-size: 13px; color: var(--slate); margin-top: 3px; }
        .results-actions { display: flex; gap: 10px; align-items: center; }

        .ads-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 16px;
        }

        .ad-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-card);
            overflow: hidden;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .ad-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 40px rgba(5,8,22,0.5), 0 0 0 1px rgba(42,174,224,0.15);
        }

        .ad-image-wrap {
            aspect-ratio: 9/16;
            overflow: hidden;
            background: var(--ink);
        }
        .ad-image { width: 100%; height: 100%; object-fit: contain; display: block; }
        .ad-footer {
            padding: 10px 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-top: 1px solid var(--border);
        }
        .ad-label { font-size: 11px; color: var(--slate); font-weight: 500; }
        .ad-angle { font-size: 11px; color: var(--slate); margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 140px; opacity: 0.7; }

        /* Spinner */
        .spinner {
            display: inline-block;
            width: 13px;
            height: 13px;
            border: 2px solid rgba(5,8,22,0.3);
            border-top-color: var(--ink);
            border-radius: 50%;
            animation: spin 0.7s linear infinite;
            vertical-align: middle;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 12px 18px;
            font-size: 13px;
            z-index: 999;
            opacity: 0;
            transform: translateY(8px);
            transition: opacity 0.2s, transform 0.2s;
            pointer-events: none;
            box-shadow: 0 8px 24px rgba(5,8,22,0.5);
        }
        .toast.visible { opacity: 1; transform: translateY(0); }

        /* Cyan accent line on cards (subtle top border) */
        .card { border-top: 2px solid rgba(42,174,224,0.3); }
    </style>
</head>
<body>
    <div class="app">

        <!-- ===== STATE 0: SETUP ===== -->
        <div id="setup-state" class="state">
            <div class="setup-card">
                <div class="setup-logo">âœ¦</div>
                <h2>Meta Ads Creator</h2>
                <p>Enter your Gemini API key to get started.<br>It's saved in your browser â€” never shared.</p>
                <div class="field">
                    <label>Gemini API Key</label>
                    <input type="password" id="api-key-input" placeholder="AIzaSy..." autocomplete="off" />
                </div>
                <button class="btn btn-primary" id="save-key-btn" onclick="saveApiKey()" style="width:100%">
                    Save &amp; Start â†’
                </button>
                <p class="setup-help">
                    Get your free key at <a href="https://aistudio.google.com/apikey" target="_blank">aistudio.google.com/apikey</a>
                </p>
            </div>
        </div>

        <!-- ===== STATE 1: FORM ===== -->
        <div id="form-state" class="state">
            <div class="header">
                <div class="header-title">
                    <div class="dot"></div>
                    <h1>Meta Ads Creator</h1>
                </div>
                <button class="icon-btn" onclick="showState('setup-state')" title="Change API key">âš™</button>
            </div>

            <div class="error-banner" id="form-error"></div>

            <div class="card">
                <div class="form-grid">
                    <div class="field">
                        <label>Landing Page URL</label>
                        <input type="url" id="url-input" placeholder="https://yourproduct.com" />
                    </div>
                    <div class="field">
                        <label>Target Niche</label>
                        <input type="text" id="niche-input" placeholder="e.g. fitness enthusiasts aged 25â€“40" />
                    </div>
                </div>

                <hr class="section-divider">

                <div class="templates-label-row">
                    <label>Ad Templates</label>
                    <span class="templates-hint">Click to select â€¢ one ad generated per template</span>
                </div>
                <div id="templates-grid" class="templates-grid">
                    <div class="no-templates" id="no-templates-msg">
                        Loading templates...
                    </div>
                </div>

                <div class="form-footer">
                    <span class="selection-info" id="selection-count">No templates selected</span>
                    <button class="btn btn-primary" id="generate-btn" onclick="startGeneration()">
                        Generate Ads âœ¦
                    </button>
                </div>
            </div>
        </div>

        <!-- ===== STATE 2: PROGRESS ===== -->
        <div id="progress-state" class="state">
            <div class="progress-wrap">
                <div class="progress-header">
                    <h2>Creating your ads...</h2>
                    <p id="progress-subtitle">This takes 1â€“3 minutes depending on the number of templates selected.</p>
                </div>

                <ul class="progress-steps">
                    <li class="step-item" id="step-fetch">
                        <div class="step-icon" id="step-fetch-icon">ğŸŒ</div>
                        <div class="step-body">
                            <h4>Reading landing page</h4>
                            <p class="step-detail" id="step-fetch-detail">Sending URL to Gemini...</p>
                        </div>
                    </li>
                    <li class="step-item" id="step-analyze">
                        <div class="step-icon" id="step-analyze-icon">ğŸ§ </div>
                        <div class="step-body">
                            <h4>Analyzing brand &amp; niche</h4>
                            <p class="step-detail" id="step-analyze-detail">Running 9-section brand analysis...</p>
                        </div>
                    </li>
                    <li class="step-item" id="step-image">
                        <div class="step-icon" id="step-image-icon">ğŸ–¼</div>
                        <div class="step-body">
                            <h4>Extracting product image</h4>
                            <p class="step-detail" id="step-image-detail">Locating product visuals...</p>
                        </div>
                    </li>
                    <li class="step-item" id="step-gen">
                        <div class="step-icon" id="step-gen-icon">âœ¨</div>
                        <div class="step-body">
                            <h4>Generating ads with Gemini</h4>
                            <p class="step-detail" id="step-gen-detail">Waiting...</p>
                        </div>
                    </li>
                </ul>

                <div class="progress-bar-wrap">
                    <div class="progress-bar" id="progress-bar"></div>
                </div>
            </div>
        </div>

        <!-- ===== STATE 3: RESULTS ===== -->
        <div id="results-state" class="state">
            <div class="results-header">
                <div>
                    <h2>Your Ads are Ready</h2>
                    <p class="results-meta" id="results-meta"></p>
                </div>
                <div class="results-actions">
                    <button class="btn btn-secondary btn-sm" onclick="goBackToForm()">â† New Generation</button>
                    <button class="btn btn-primary btn-sm" id="download-all-btn" onclick="downloadAll()">â¬‡ Download All</button>
                </div>
            </div>
            <div id="ads-grid" class="ads-grid"></div>
        </div>

    </div>

    <div class="toast" id="toast"></div>

    <script src="https://cdn.jsdelivr.net/npm/jszip@3/dist/jszip.min.js"></script>
    <script>

// =============================================================================
// CONFIGURATION â€” Update TEMPLATE_FILES when you add images to /templates/
// =============================================================================
const TEMPLATE_FILES = [
    // 'template-01.jpg',
    // 'template-02.jpg',
    // 'template-03.jpg',
    // Add your template filenames here, or create templates/manifest.json
];

const MODEL_TEXT  = 'gemini-2.0-flash';
const MODEL_IMAGE = 'gemini-3-pro-image-preview';
const GEMINI_API  = 'https://generativelanguage.googleapis.com/v1beta/models/';
// Multiple CORS proxies tried in order (fallback if one is down/blocked)
const PROXIES = [
    url => `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,
    url => `https://corsproxy.io/?${encodeURIComponent(url)}`,
    url => `https://api.codetabs.com/v1/proxy/?quest=${encodeURIComponent(url)}`,
];

// =============================================================================
// APP STATE
// =============================================================================
let apiKey               = localStorage.getItem('gemini_api_key') || '';
let generatedAds         = [];
let selectedTempls       = new Set();
let lastUrl              = '';
let lastNiche            = '';
let templateAnalysisCache = new Map(); // filename â†’ analysis object

// =============================================================================
// UI HELPERS
// =============================================================================
function showState(id) {
    document.querySelectorAll('.state').forEach(s => s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
}

function setStepActive(id) {
    document.getElementById(id).classList.add('active');
}
function setStepDone(id, detail) {
    const el = document.getElementById(id);
    el.classList.remove('active');
    el.classList.add('done');
    document.getElementById(id + '-icon').textContent = 'âœ“';
    if (detail) document.getElementById(id + '-detail').textContent = detail;
}
function setStepError(id, msg) {
    const el = document.getElementById(id);
    el.classList.remove('active');
    el.classList.add('error');
    document.getElementById(id + '-icon').textContent = 'âœ•';
    if (msg) document.getElementById(id + '-detail').textContent = msg;
}
function updateDetail(id, msg) {
    document.getElementById(id + '-detail').textContent = msg;
}
function setProgress(pct) {
    document.getElementById('progress-bar').style.width = Math.min(pct, 100) + '%';
}

function showFormError(msg) {
    const el = document.getElementById('form-error');
    el.textContent = msg;
    el.classList.add('visible');
}
function hideFormError() {
    document.getElementById('form-error').classList.remove('visible');
}

function showToast(msg, ms = 3500) {
    const el = document.getElementById('toast');
    el.textContent = msg;
    el.classList.add('visible');
    setTimeout(() => el.classList.remove('visible'), ms);
}

// =============================================================================
// SETUP / API KEY
// =============================================================================
function saveApiKey() {
    const key = document.getElementById('api-key-input').value.trim();
    if (!key || !key.startsWith('AIza')) {
        alert('Please enter a valid Gemini API key (starts with AIza...)');
        return;
    }
    apiKey = key;
    localStorage.setItem('gemini_api_key', key);
    showState('form-state');
    loadTemplates();
}

// =============================================================================
// TEMPLATE LOADING
// =============================================================================
async function loadTemplates() {
    const grid = document.getElementById('templates-grid');
    const msg  = document.getElementById('no-templates-msg');

    // Try manifest.json first, then fall back to TEMPLATE_FILES constant
    let files = [...TEMPLATE_FILES];
    try {
        const res = await fetch('templates/manifest.json');
        if (res.ok) {
            const json = await res.json();
            if (Array.isArray(json) && json.length > 0) files = json;
        }
    } catch (_) {}

    if (files.length === 0) {
        msg.innerHTML = `
            No templates found yet.<br>
            <small>Add images to <code>templates/</code> and list them in <code>TEMPLATE_FILES</code> (line 1 of script) or create <code>templates/manifest.json</code></small>
        `;
        updateSelectionCount();
        return;
    }

    msg.style.display = 'none';

    for (const filename of files) {
        const card = document.createElement('div');
        card.className = 'template-card';
        card.dataset.file = filename;
        card.innerHTML = `
            <img src="templates/${filename}" alt="${filename}"
                 onerror="this.parentElement.style.display='none'">
            <div class="check-badge">âœ“</div>
            <span class="template-name">${filename.replace(/\.[^.]+$/, '')}</span>
        `;
        card.addEventListener('click', () => toggleTemplate(card, filename));
        grid.appendChild(card);
    }
    updateSelectionCount();
}

function toggleTemplate(card, file) {
    if (selectedTempls.has(file)) {
        selectedTempls.delete(file);
        card.classList.remove('selected');
    } else {
        selectedTempls.add(file);
        card.classList.add('selected');
    }
    updateSelectionCount();
}

function updateSelectionCount() {
    const n = selectedTempls.size;
    document.getElementById('selection-count').textContent =
        n === 0 ? 'No templates selected â€” will generate 1 ad from scratch'
                : `${n} template${n > 1 ? 's' : ''} selected`;
}

// =============================================================================
// GEMINI API CALLS
// =============================================================================
async function geminiText(prompt) {
    const url = `${GEMINI_API}${MODEL_TEXT}:generateContent?key=${apiKey}`;
    const res = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            contents: [{ parts: [{ text: prompt }] }],
            generationConfig: { temperature: 0.7, maxOutputTokens: 8192 }
        })
    });
    if (!res.ok) {
        const e = await res.json().catch(() => ({}));
        throw new Error(e.error?.message || `Gemini text error (${res.status})`);
    }
    const data = await res.json();
    return data.candidates?.[0]?.content?.parts?.[0]?.text || '';
}

// Gemini fetches the URL itself (server-side, bypasses CORS/bot protection)
async function geminiTextWithUrl(prompt) {
    const url = `${GEMINI_API}${MODEL_TEXT}:generateContent?key=${apiKey}`;
    const res = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            contents: [{ parts: [{ text: prompt }] }],
            tools: [{ url_context: {} }],
            generationConfig: { temperature: 0.7, maxOutputTokens: 8192 }
        })
    });
    if (!res.ok) {
        const e = await res.json().catch(() => ({}));
        throw new Error(e.error?.message || `Gemini error (${res.status})`);
    }
    const data = await res.json();
    // URL context responses may split text across parts â€” join them all
    const parts = data.candidates?.[0]?.content?.parts || [];
    return parts.filter(p => p.text).map(p => p.text).join('');
}

async function geminiImage(parts) {
    const url = `${GEMINI_API}${MODEL_IMAGE}:generateContent?key=${apiKey}`;
    const res = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            contents: [{ parts }],
            generationConfig: { responseModalities: ['IMAGE', 'TEXT'] }
        })
    });
    if (!res.ok) {
        const e = await res.json().catch(() => ({}));
        throw new Error(e.error?.message || `Gemini image error (${res.status})`);
    }
    const data = await res.json();
    const imgPart = data.candidates?.[0]?.content?.parts?.find(p => p.inlineData);
    if (!imgPart) return null;
    return `data:${imgPart.inlineData.mimeType};base64,${imgPart.inlineData.data}`;
}

// =============================================================================
// TEMPLATE CONCEPT ANALYSIS (cheap Flash call â€” extracts precise layout blueprint)
// =============================================================================
async function analyzeTemplate(tmplBase64, tmplFilename) {
    // Return cached result if we've already analysed this template
    if (tmplFilename && templateAnalysisCache.has(tmplFilename)) {
        return templateAnalysisCache.get(tmplFilename);
    }

    const mimeType = tmplBase64.match(/data:([^;]+)/)?.[1] || 'image/jpeg';
    const url = `${GEMINI_API}${MODEL_TEXT}:generateContent?key=${apiKey}`;

    const prompt = `You are a precise visual layout analyst. Study this ad template image carefully and extract its exact layout blueprint so it can be reproduced with different product content.

Respond ONLY with a valid JSON object (no markdown, no code blocks):

{
  "adFormat": "choose exactly one: Breaking Headline | Us vs Them | USP Callouts | Social Proof / Reviews | Before / After | Problem / Solution | Lifestyle / Aspirational | Offer / Discount | Tutorial / How-to | UGC Style",
  "adConcept": "1-2 sentences on the strategic concept â€” what this format does to persuade the viewer",
  "backgroundTreatment": "exact description: e.g. 'solid dark navy #1a2333', 'lifestyle photo with 60% dark overlay', 'white background with coral accent strip at bottom'",
  "colorPalette": ["primary bg color", "text color", "accent/CTA color", "secondary color"],
  "layoutZones": [
    {
      "zone": "descriptive name e.g. 'hero headline', 'product image', 'bullet benefit list', 'CTA button'",
      "verticalPosition": "approximate % from top, e.g. '0â€“15%' or '60â€“80%'",
      "horizontalAlignment": "left / center / right / full-width",
      "description": "exactly what appears here and how it is visually treated",
      "textStyle": "if text zone: size (huge/large/medium/small), weight (bold/regular), case (ALL CAPS/Title Case/sentence), color"
    }
  ],
  "productImagePlacement": "describe exactly how/where the product photo is shown, or null if none",
  "hasLogo": true or false,
  "logoDescription": "where logo appears and how it looks, or null",
  "copyApproach": "the copywriting angle and tone",
  "contentSwapRules": "3-4 specific rules that MUST be followed when replacing content â€” what defines this template's identity"
}`;

    try {
        const res = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                contents: [{
                    parts: [
                        { text: prompt },
                        { inlineData: { mimeType, data: tmplBase64.split(',')[1] } }
                    ]
                }],
                generationConfig: { temperature: 0.1, maxOutputTokens: 1500 }
            })
        });

        if (!res.ok) return null;

        const data = await res.json();
        const text = data.candidates?.[0]?.content?.parts?.[0]?.text || '';

        const cleaned = text.replace(/^```json?\s*/i, '').replace(/\s*```$/i, '').trim();
        const parsed = JSON.parse(cleaned);

        // Cache for reuse within this generation run
        if (tmplFilename) templateAnalysisCache.set(tmplFilename, parsed);
        return parsed;

    } catch (_) {
        return null; // Non-fatal â€” generation continues without layout blueprint
    }
}

// =============================================================================
// IMAGE UTILITIES
// =============================================================================
function blobToDataURL(blob) {
    return new Promise((resolve, reject) => {
        const r = new FileReader();
        r.onload  = e => resolve(e.target.result);
        r.onerror = reject;
        r.readAsDataURL(blob);
    });
}

async function urlToBase64(imageUrl) {
    if (!imageUrl) return null;
    const attempts = [imageUrl, ...PROXIES.map(fn => fn(imageUrl))];
    for (const u of attempts) {
        try {
            const res = await fetch(u, { signal: AbortSignal.timeout(12000) });
            if (!res.ok) continue;
            const blob = await res.blob();
            if (!blob.type.startsWith('image/')) continue;
            return await blobToDataURL(blob);
        } catch (_) {}
    }
    return null;
}

// =============================================================================
// LANDING PAGE FETCH
// =============================================================================
async function fetchPage(rawUrl) {
    let html = null;
    let lastError = '';

    // Try each proxy in order until one works
    for (const buildUrl of PROXIES) {
        try {
            const res = await fetch(buildUrl(rawUrl), {
                signal: AbortSignal.timeout(20000)
            });
            if (res.ok) {
                const text = await res.text();
                // Sanity check: make sure we got actual HTML
                if (text.length > 200 && (text.includes('<') || text.includes('{'))) {
                    html = text;
                    break;
                }
            }
            lastError = `HTTP ${res.status}`;
        } catch (e) {
            lastError = e.message;
        }
    }

    if (!html) {
        throw new Error(`Could not fetch the landing page (${lastError}). Try a different URL or check your internet connection.`);
    }

    // Extract product image â€” try multiple patterns including Shopify JSON-LD
    let ogImage = null;

    // 1. OG / Twitter meta tags
    ogImage =
        (html.match(/property="og:image"\s+content="([^"]+)"/i) ||
         html.match(/content="([^"]+)"\s+property="og:image"/i) ||
         html.match(/property="og:image:secure_url"\s+content="([^"]+)"/i) ||
         html.match(/name="twitter:image"\s+content="([^"]+)"/i) ||
         html.match(/content="([^"]+)"\s+name="twitter:image"/i))?.[1] || null;

    // 2. Shopify JSON-LD structured data (product pages)
    if (!ogImage) {
        const ldMatch = html.match(/<script[^>]+type="application\/ld\+json"[^>]*>([\s\S]*?)<\/script>/gi);
        if (ldMatch) {
            for (const block of ldMatch) {
                try {
                    const json = JSON.parse(block.replace(/<[^>]+>/g, ''));
                    const img = json.image?.[0] || json.image || json.logo?.url;
                    if (img && typeof img === 'string' && img.startsWith('http')) {
                        ogImage = img;
                        break;
                    }
                } catch (_) {}
            }
        }
    }

    // 3. Shopify CDN images (cdn.shopify.com)
    if (!ogImage) {
        const shopifyImg = html.match(/https:\/\/cdn\.shopify\.com\/s\/files\/[^\s"']+\.(jpg|jpeg|png|webp)/i)?.[0];
        if (shopifyImg) ogImage = shopifyImg;
    }

    // Ensure HTTPS
    if (ogImage && ogImage.startsWith('//')) ogImage = 'https:' + ogImage;

    const bodyText = html
        .replace(/<script[\s\S]*?<\/script>/gi, '')
        .replace(/<style[\s\S]*?<\/style>/gi, '')
        .replace(/<!--[\s\S]*?-->/g, '')
        .replace(/<[^>]+>/g, ' ')
        .replace(/&nbsp;/g, ' ')
        .replace(/&amp;/g, '&')
        .replace(/&lt;/g, '<')
        .replace(/&gt;/g, '>')
        .replace(/&quot;/g, '"')
        .replace(/\s+/g, ' ')
        .trim()
        .slice(0, 12000);

    return { ogImage, bodyText };
}

// =============================================================================
// BRAND ANALYSIS PROMPT â€” Direct (Gemini fetches the URL itself)
// =============================================================================
function buildAnalysisPromptDirect(url, niche) {
    return `Please fetch and read this landing page: ${url}

You are an elite brand & customer-avatar researcher and conversion strategist.
Analyze this brand in the context of the target niche: "${niche}".

Use all visible content â€” headlines, hero copy, CTAs, product names, pricing signals,
trust markers, imagery, navigation labels, metadata â€” to make evidence-based inferences.

Operational rules:
- Run at least 5 independent reasoning passes internally; output only final conclusions.
- Do not output internal reasoning steps.
- Tone: analytical, precise, and practical.

Analyze and extract the following:

1) Who are we speaking to?
Demographics (age ranges, sex/gender skew, typical locations, job roles/industries, income ranges) and psychographics (primary interests & hobbies, affinity audiences useful for ad targeting â€” list 6â€“10 items).

2) What is the transformation we are offering?
Short summary (1â€“3 sentences) and 3 concrete outcomes the customer experiences after using the offering.

3) What is the measurable difference we are offering?
For each measurable benefit, specify before-state metric and expected after-state metric.

4) What is the emotional why?
Top 6 emotional motivations that drive purchase decisions.

5) What is the rational why?
Top 6 rational reasons (features, ROI, performance, guarantee, price, speed).

6) Why not?
Top 6 likely objections with: the objection statement, likely root cause, and a concise objection response.

7) Tone of voice
4â€“8 bullets describing tone attributes, word-level guidelines, and 3 sample micro-phrases (<=10 words each).

8) Brand representative
Persona: age range, sex if relevant, professional background, voice, wardrobe/style, top 3 phrases they would use.

9) What are the USPs of the product?
Top 10 unique selling points.

CRITICAL â€” OUTPUT FORMAT:
You MUST respond with ONLY a valid JSON object. No markdown, no code blocks, no preamble. Just raw JSON starting with { and ending with }.

{
  "brandName": "string",
  "productName": "string",
  "productImageUrl": "the main product image URL from the page (full https URL)",
  "targetAudience": {
    "demographics": "string summary",
    "psychographics": ["interest 1", "interest 2"],
    "affinityAudiences": ["audience 1", "audience 2", "audience 3", "audience 4", "audience 5"]
  },
  "transformation": {
    "summary": "string",
    "outcomes": ["outcome 1", "outcome 2", "outcome 3"]
  },
  "measurableDifference": [
    {"before": "...", "after": "..."}
  ],
  "emotionalWhy": ["emotion 1", "emotion 2", "emotion 3", "emotion 4", "emotion 5", "emotion 6"],
  "rationalWhy": ["reason 1", "reason 2", "reason 3", "reason 4", "reason 5", "reason 6"],
  "objections": [
    {"objection": "...", "rootCause": "...", "response": "..."}
  ],
  "toneOfVoice": ["tone attribute 1", "tone attribute 2"],
  "brandRepresentative": "string description",
  "USPs": ["usp 1", "usp 2", "usp 3", "usp 4", "usp 5"],
  "adAngles": [
    "Angle 1 tailored for ${niche}",
    "Angle 2 tailored for ${niche}",
    "Angle 3 tailored for ${niche}",
    "Angle 4 tailored for ${niche}",
    "Angle 5 tailored for ${niche}"
  ],
  "suggestedHeadlines": [
    "Headline 1 for ${niche}",
    "Headline 2 for ${niche}",
    "Headline 3 for ${niche}",
    "Headline 4 for ${niche}",
    "Headline 5 for ${niche}"
  ]
}`;
}

// =============================================================================
// BRAND ANALYSIS PROMPT â€” Fallback (pre-fetched HTML passed in)
// =============================================================================
function buildAnalysisPrompt(url, niche, bodyText, ogImageUrl) {
    return `You are an elite brand & customer-avatar researcher and conversion strategist. Your role is to analyze a single brand from its landing page in context of the desired niche we want to target, which is "${niche}".

IMPORTANT: The landing page content has been pre-fetched for you below. Use this content for your analysis instead of attempting to crawl the URL directly.

Landing page URL: ${url}
${ogImageUrl ? `Main product/brand image URL: ${ogImageUrl}` : ''}

LANDING PAGE CONTENT:
---
${bodyText}
---

Analyze this page with this niche context in mind: "${niche}"

Use the entire visible content and key indicators (headlines, hero copy, CTAs, product names, pricing signals, trust markers, imagery descriptions, navigation labels, metadata) to make evidence-based inferences.

Operational rules:
- Reasoning method: Internally run Chain-of-Thought style analysis with at least 5 independent reasoning passes; do NOT output internal chains â€” only output final aggregated results.
- Do not output internal reasoning steps; share only final conclusions and evidence.
- Be as comprehensive as necessary.
- Tone: analytical, precise, and practical.

Analyze and extract the following:

1) Who are we speaking to?
Demographics (age ranges, sex/gender skew, typical locations, job roles/industries, income ranges) and psychographics (primary interests & hobbies, affinity audiences useful for ad targeting â€” list 6â€“10 items).

2) What is the transformation we are offering?
Short summary (1â€“3 sentences) and 3 concrete outcomes the customer experiences after using the offering.

3) What is the measurable difference we are offering?
For each measurable benefit, specify before-state metric and expected after-state metric.

4) What is the emotional why?
Top 6 emotional motivations that drive purchase decisions.

5) What is the rational why?
Top 6 rational reasons (features, ROI, performance, guarantee, price, speed).

6) Why not?
Top 6 likely objections with: the objection statement, likely root cause, and a concise objection response.

7) Tone of voice
4â€“8 bullets describing tone attributes, word-level guidelines, and 3 sample micro-phrases (<=10 words each).

8) Brand representative
Persona: age range, sex if relevant, professional background, voice, wardrobe/style, top 3 phrases they would use.

9) What are the USPs of the product?
Top 10 unique selling points.

CRITICAL â€” OUTPUT FORMAT:
You MUST respond with ONLY a valid JSON object. No markdown, no code blocks, no preamble. Just the raw JSON starting with { and ending with }.

Use this exact structure:
{
  "brandName": "string",
  "productName": "string",
  "productImageUrl": "${ogImageUrl || ''}",
  "targetAudience": {
    "demographics": "string summary",
    "psychographics": ["interest 1", "interest 2"],
    "affinityAudiences": ["audience 1", "audience 2", "audience 3", "audience 4", "audience 5"]
  },
  "transformation": {
    "summary": "string",
    "outcomes": ["outcome 1", "outcome 2", "outcome 3"]
  },
  "measurableDifference": [
    {"before": "...", "after": "..."}
  ],
  "emotionalWhy": ["emotion 1", "emotion 2", "emotion 3", "emotion 4", "emotion 5", "emotion 6"],
  "rationalWhy": ["reason 1", "reason 2", "reason 3", "reason 4", "reason 5", "reason 6"],
  "objections": [
    {"objection": "...", "rootCause": "...", "response": "..."}
  ],
  "toneOfVoice": ["tone attribute 1", "tone attribute 2"],
  "brandRepresentative": "string description",
  "USPs": ["usp 1", "usp 2", "usp 3", "usp 4", "usp 5"],
  "adAngles": [
    "Angle 1 tailored for ${niche}",
    "Angle 2 tailored for ${niche}",
    "Angle 3 tailored for ${niche}",
    "Angle 4 tailored for ${niche}",
    "Angle 5 tailored for ${niche}"
  ],
  "suggestedHeadlines": [
    "Headline 1 for ${niche}",
    "Headline 2 for ${niche}",
    "Headline 3 for ${niche}",
    "Headline 4 for ${niche}",
    "Headline 5 for ${niche}"
  ]
}`;
}

// =============================================================================
// AD IMAGE GENERATION PROMPT
// =============================================================================
function buildAdPrompt(analysis, niche, adAngle, headline, templateConcept) {

    const hasTemplate = !!templateConcept;

    // Build zone-by-zone layout instructions from the blueprint
    let zoneInstructions = '';
    if (hasTemplate && Array.isArray(templateConcept.layoutZones)) {
        zoneInstructions = templateConcept.layoutZones.map(z =>
            `  â€¢ [${z.verticalPosition || ''}] ${z.zone}: ${z.description}${z.textStyle ? ` â€” text style: ${z.textStyle}` : ''}`
        ).join('\n');
    }

    const templateBlock = hasTemplate ? `
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
LAYOUT BLUEPRINT â€” reproduce this EXACTLY
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Ad Format: ${templateConcept.adFormat}
Strategic Concept: ${templateConcept.adConcept}
Background: ${templateConcept.backgroundTreatment}
Colours: ${Array.isArray(templateConcept.colorPalette) ? templateConcept.colorPalette.join(', ') : templateConcept.colorPalette}
Copy Approach: ${templateConcept.copyApproach}

LAYOUT ZONES (replicate positions, sizes, and styling precisely):
${zoneInstructions}

Product Image Placement: ${templateConcept.productImagePlacement || 'match template'}
Content Swap Rules: ${templateConcept.contentSwapRules}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”` : '';

    const imageNote = hasTemplate
        ? `IMAGE 1 (first attached) = LAYOUT TEMPLATE â€” your pixel-faithful visual blueprint.
IMAGE 2 (second attached, if present) = PRODUCT PHOTO â€” use this as the product image in the output.`
        : `IMAGE 1 (attached) = PRODUCT PHOTO â€” feature this prominently as the hero.`;

    return `You are performing a CONTENT SWAP on an ad template. This is NOT a new design â€” it is a faithful reproduction of the template layout with new product content.

${imageNote}
${templateBlock}

NEW CONTENT TO INSERT:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
PRODUCT: ${analysis.productName || 'Product'}
BRAND: ${analysis.brandName || 'Brand'}
TARGET NICHE: ${niche}
AD ANGLE: ${adAngle}
HEADLINE: "${headline}"
KEY BENEFIT: ${analysis.USPs?.[0] || analysis.rationalWhy?.[0] || ''}
TONE: ${analysis.toneOfVoice?.[0] || 'Professional and compelling'}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ABSOLUTE RULES â€” never break these:
1. LAYOUT: Every element stays in the exact same position as the template â€” same zones, same proportions, same visual hierarchy
2. STYLE: Use the identical background treatment, colour palette, and typography style as the template
3. NO LOGOS: Do NOT add any brand logos, company marks, or watermarks. The only logos permitted are any already visible on the product photo itself
4. NO INVENTION: Do not add decorative elements, borders, icons, or shapes that are not in the template
5. PRODUCT IMAGE: Place the product photo exactly where the template shows a product/hero image â€” same size, same position, same treatment (e.g. if template has product on white background floating in top half, do the same)
6. ASPECT RATIO: Output must be vertical 9:16 (portrait, 1080Ã—1920)`;
}

// =============================================================================
// MAIN GENERATION FLOW
// =============================================================================
async function startGeneration() {
    const url   = document.getElementById('url-input').value.trim();
    const niche = document.getElementById('niche-input').value.trim();

    if (!url)   { showFormError('Please enter a landing page URL.'); return; }
    if (!niche) { showFormError('Please enter a target niche.'); return; }
    if (!apiKey){ showState('setup-state'); return; }

    lastUrl   = url;
    lastNiche = niche;
    hideFormError();

    // Reset progress UI
    ['step-fetch', 'step-analyze', 'step-image', 'step-gen'].forEach(id => {
        const el = document.getElementById(id);
        el.classList.remove('active', 'done', 'error');
        const icons = { 'step-fetch': 'ğŸŒ', 'step-analyze': 'ğŸ§ ', 'step-image': 'ğŸ–¼', 'step-gen': 'âœ¨' };
        document.getElementById(id + '-icon').textContent = icons[id];
    });

    setProgress(0);
    generatedAds = [];
    templateAnalysisCache.clear();
    document.getElementById('ads-grid').innerHTML = '';
    showState('progress-state');

    try {
        // â”€â”€ Step 1: Read landing page â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // Primary: Gemini URL context (Google fetches server-side â€” bypasses all bot protection)
        // Fallback: CORS proxy if URL context unavailable
        setStepActive('step-fetch');
        updateDetail('step-fetch', 'Sending URL to Gemini...');

        let rawAnalysis = null;
        let fallbackOgImage = null;

        try {
            rawAnalysis = await geminiTextWithUrl(buildAnalysisPromptDirect(url, niche));
            setStepDone('step-fetch', 'Page read by Gemini âœ“');
        } catch (urlCtxErr) {
            // URL context failed â€” fall back to CORS proxy
            updateDetail('step-fetch', 'Trying CORS proxy fallback...');
            const page = await fetchPage(url); // throws its own error if all proxies fail
            fallbackOgImage = page.ogImage;
            setStepDone('step-fetch', `Fetched Â· ${(page.bodyText.length / 1000).toFixed(1)}k chars`);
            setProgress(15);
            setStepActive('step-analyze');
            updateDetail('step-analyze', 'Running brand & niche analysis...');
            rawAnalysis = await geminiText(buildAnalysisPrompt(url, niche, page.bodyText, page.ogImage));
        }

        setProgress(15);

        // â”€â”€ Step 2: Parse analysis â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        setStepActive('step-analyze');
        updateDetail('step-analyze', 'Parsing brand analysis...');

        let analysis;
        try {
            const cleaned = rawAnalysis
                .replace(/^```json?\s*/i, '')
                .replace(/\s*```$/i, '')
                .trim();
            analysis = JSON.parse(cleaned);
        } catch (_) {
            throw new Error('Analysis returned unexpected format. Please try again.');
        }

        // If URL context didn't find a product image, use fallback ogImage
        if (!analysis.productImageUrl && fallbackOgImage) {
            analysis.productImageUrl = fallbackOgImage;
        }

        setStepDone('step-analyze',
            `${analysis.brandName || 'Brand'} Â· ${analysis.adAngles?.length || 0} ad angles identified`);
        setProgress(35);

        // â”€â”€ Step 3: Product image â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        setStepActive('step-image');
        const imgUrl = analysis.productImageUrl;
        updateDetail('step-image', imgUrl ? 'Downloading product image...' : 'No product image found, continuing...');

        let productImgB64 = null;
        if (imgUrl) productImgB64 = await urlToBase64(imgUrl);

        setStepDone('step-image', productImgB64
            ? 'âœ“ Product image ready'
            : 'Proceeding without product image');
        setProgress(45);

        // â”€â”€ Step 4: Generate ads â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        setStepActive('step-gen');

        const templates = selectedTempls.size > 0
            ? [...selectedTempls]
            : [null]; // generate 1 ad without template if none selected

        const total = templates.length;

        for (let i = 0; i < total; i++) {
            const tmpl = templates[i];

            // Load template image if selected
            let tmplB64 = null;
            if (tmpl) tmplB64 = await urlToBase64(`templates/${tmpl}`);

            // Analyse template concept with Gemini Flash (cheap call â€” understands the ad angle/format)
            let templateConcept = null;
            if (tmplB64) {
                updateDetail('step-gen', `Analysing template ${i + 1} of ${total}...`);
                templateConcept = await analyzeTemplate(tmplB64, tmpl);
            }

            updateDetail('step-gen', `Generating ad ${i + 1} of ${total}${tmpl ? ` (${templateConcept?.adFormat || tmpl})` : ''}...`);

            // Build prompt inputs â€” use template concept to pick the most fitting angle/headline
            const adAngle  = analysis.adAngles?.[i % Math.max(analysis.adAngles?.length || 1, 1)] || 'key benefit focused';
            const headline = analysis.suggestedHeadlines?.[i % Math.max(analysis.suggestedHeadlines?.length || 1, 1)]
                          || analysis.USPs?.[0] || 'See the difference today';

            const parts = [{ text: buildAdPrompt(analysis, niche, adAngle, headline, templateConcept) }];

            // IMAGE 1: template goes FIRST (it is the layout master)
            if (tmplB64) {
                parts.push({
                    inlineData: {
                        mimeType: tmplB64.match(/data:([^;]+)/)?.[1] || 'image/jpeg',
                        data: tmplB64.split(',')[1]
                    }
                });
            }

            // IMAGE 2: product image goes SECOND
            if (productImgB64) {
                parts.push({
                    inlineData: {
                        mimeType: productImgB64.match(/data:([^;]+)/)?.[1] || 'image/jpeg',
                        data: productImgB64.split(',')[1]
                    }
                });
            }

            const adImg = await geminiImage(parts);

            if (adImg) {
                generatedAds.push({ src: adImg, template: tmpl, angle: adAngle, headline });
                appendAdCard(adImg, i + 1, templateConcept?.adFormat || adAngle);
            }

            setProgress(45 + 55 * (i + 1) / total);
        }

        setStepDone('step-gen', `${generatedAds.length} ad${generatedAds.length !== 1 ? 's' : ''} generated`);
        setProgress(100);

        document.getElementById('results-meta').textContent =
            `${generatedAds.length} ad${generatedAds.length !== 1 ? 's' : ''} Â· ${niche}`;

        await new Promise(r => setTimeout(r, 500));
        showState('results-state');

    } catch (err) {
        console.error(err);
        ['step-gen', 'step-image', 'step-analyze', 'step-fetch'].forEach(id => {
            if (document.getElementById(id).classList.contains('active')) {
                setStepError(id, err.message);
            }
        });
        await new Promise(r => setTimeout(r, 2500));
        showState('form-state');
        showFormError('Error: ' + err.message);
    }
}

// =============================================================================
// RESULTS
// =============================================================================
function appendAdCard(imgSrc, index, angle) {
    const grid = document.getElementById('ads-grid');
    const card = document.createElement('div');
    card.className = 'ad-card';
    card.innerHTML = `
        <div class="ad-image-wrap">
            <img class="ad-image" src="${imgSrc}" alt="Ad ${index}" />
        </div>
        <div class="ad-footer">
            <div>
                <div class="ad-label">Ad ${index}</div>
                <div class="ad-angle">${angle}</div>
            </div>
            <button class="btn btn-secondary btn-sm"
                    onclick="downloadSingle('${imgSrc}','meta-ad-${index}.jpg')">â¬‡</button>
        </div>
    `;
    grid.appendChild(card);
}

function downloadSingle(dataUrl, filename) {
    const a = document.createElement('a');
    a.href = dataUrl;
    a.download = filename;
    a.click();
}

async function downloadAll() {
    if (!generatedAds.length) return;
    const btn = document.getElementById('download-all-btn');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner"></span> Zipping...';
    try {
        const zip = new JSZip();
        generatedAds.forEach((ad, i) => {
            const ext  = ad.src.match(/data:image\/([^;]+)/)?.[1] || 'jpg';
            const data = ad.src.split(',')[1];
            zip.file(`meta-ad-${i + 1}.${ext}`, data, { base64: true });
        });
        const blob = await zip.generateAsync({ type: 'blob' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `meta-ads-${Date.now()}.zip`;
        a.click();
        showToast(`âœ“ Downloaded ${generatedAds.length} ads as ZIP`);
    } catch (e) {
        showToast('Download failed: ' + e.message);
    } finally {
        btn.disabled = false;
        btn.innerHTML = 'â¬‡ Download All';
    }
}

function goBackToForm() {
    document.getElementById('url-input').value   = lastUrl;
    document.getElementById('niche-input').value = lastNiche;
    showState('form-state');
}

// =============================================================================
// INIT
// =============================================================================
function init() {
    if (!apiKey) {
        showState('setup-state');
    } else {
        showState('form-state');
        loadTemplates();
    }

    document.getElementById('api-key-input').addEventListener('keydown', e => {
        if (e.key === 'Enter') saveApiKey();
    });
    ['url-input', 'niche-input'].forEach(id => {
        document.getElementById(id).addEventListener('keydown', e => {
            if (e.key === 'Enter') startGeneration();
        });
    });
}

init();

    </script>
</body>
</html>
